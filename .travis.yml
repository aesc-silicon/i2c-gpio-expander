# SPDX-FileCopyrightText: 2025 aesc silicon
#
# SPDX-License-Identifier: CERN-OHL-S-2.0

language: generic

os: linux
dist: jammy

# Only run on pull requests to main branch
branches:
  only:
    - main

# Set timeout to 60 minutes
timeout: 3600

# Conditional logic for PRs vs Cron
if: type IN (pull_request, cron)

install:
  # Install dependencies
  - git config --global color.ui false
  - sudo snap install task --classic
  - sudo apt-get update
  - sudo apt-get install -y virtualenv

script:
  # Use appropriate branch: PR branch for PRs, main for cron
  - |
    if [ "$TRAVIS_EVENT_TYPE" = "cron" ]; then
      BRANCH="main"
    else
      BRANCH="${TRAVIS_PULL_REQUEST_BRANCH:-main}"
    fi

  # Prepare the project
  - task install branch=${BRANCH}

  # Prepare files
  - IS_HEADLESS=true task prepare

  # Generate layout
  - IS_HEADLESS=true task layout

  # Add metal fill
  - IS_HEADLESS=true task filler

  # Run maximal DRC
  - IS_HEADLESS=true task run-drc > drc.log
  - grep -v '0 error(s)' drc.log
  - grep 'KLayout DRC Check Passed' drc.log

notifications:
  email:
    on_success: never
    on_failure: always
    recipients:
      - nightly.reports@aesc-silicon.de
